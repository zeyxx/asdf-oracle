<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="$asdfasdfa K-Metric Dashboard - Proving holder conviction on-chain">
  <title>$asdfasdfa | K-Metric Dashboard</title>

  <!-- Open Graph -->
  <meta property="og:title" content="$asdfasdfa K-Metric">
  <meta property="og:description" content="Price is noise. K is signal. On-chain verified holder conviction.">
  <meta property="og:type" content="website">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

  <!-- Styles -->
  <link rel="stylesheet" href="css/style.css?v=3">

  <!-- Tooltip styles - this is fine mode -->
  <style>
    .tooltip {
      position: relative;
      cursor: help;
    }
    .tooltip::after {
      content: attr(data-tip);
      position: absolute;
      top: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #1a0a02 0%, #2d1810 100%);
      border: 1px solid var(--fire-orange, #fb923c);
      color: #fbbf24;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.75rem;
      font-family: 'Comic Neue', cursive;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(251, 146, 60, 0.3);
    }
    .tooltip:hover::after {
      opacity: 1;
    }
    /* Panel headers: align left to avoid overflow */
    .panel-header .tooltip::after {
      left: 0;
      transform: none;
    }
    /* Fix: .panel has overflow:hidden which clips tooltips */
    .panel {
      overflow: visible !important;
    }
    .stats-row,
    .footer-stats,
    .poh-status,
    .history-panel {
      overflow: visible;
    }
    /* Pool toggle */
    .pool-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      margin-left: auto;
      margin-right: 12px;
    }
    .pool-toggle input {
      accent-color: var(--fire-orange, #fb923c);
      cursor: pointer;
    }
    .pool-toggle-label {
      font-size: 11px;
      color: #888;
      text-transform: lowercase;
    }
    .pool-toggle:hover .pool-toggle-label {
      color: var(--fire-orange, #fb923c);
    }
  </style>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- html2canvas for screenshot -->
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="logo">
        <span class="logo-fire">ğŸ”¥</span>
        <span class="logo-text">$asdfasdfa</span>
      </div>
      <div class="status-badge">
        <span class="status-dot" id="status-dot"></span>
        <span id="status-text">connecting...</span>
      </div>
    </header>

    <!-- Ticker -->
    <div class="ticker-wrap">
      <div class="ticker" id="ticker">
        <div class="ticker-item">ğŸ“Š K-metric tracks holder conviction on-chain</div>
        <div class="ticker-item">ğŸ”¥ <span class="up" id="ticker-k">--</span>% of holders maintained position</div>
        <div class="ticker-item">ğŸ’ Diamond hands verified via Helius RPC</div>
        <div class="ticker-item">ğŸ“ˆ Price is noise Â· K is signal</div>
        <div class="ticker-item">â›“ï¸ Real data Â· No fake metrics</div>
        <div class="ticker-item">ğŸ§ª Chaos is a filter</div>
        <!-- Duplicate for seamless scroll -->
        <div class="ticker-item">ğŸ“Š K-metric tracks holder conviction on-chain</div>
        <div class="ticker-item">ğŸ”¥ <span class="up" id="ticker-k-2">--</span>% of holders maintained position</div>
        <div class="ticker-item">ğŸ’ Diamond hands verified via Helius RPC</div>
        <div class="ticker-item">ğŸ“ˆ Price is noise Â· K is signal</div>
        <div class="ticker-item">â›“ï¸ Real data Â· No fake metrics</div>
        <div class="ticker-item">ğŸ§ª Chaos is a filter</div>
      </div>
    </div>

    <!-- Main K-Metric Panel -->
    <main id="main-content" class="panel">
      <div class="panel-header">
        <span class="panel-title tooltip" data-tip="ğŸ• this is fine - we track who holds through chaos">holder conviction metric</span>
        <span class="panel-title">$asdfasdfa</span>
      </div>

      <!-- K Formula - Mathematical Beauty -->
      <div class="k-formula tooltip" data-tip="Ï† Golden Ratio proportions Â· 552 sacred timing">
        <span class="k-letter">K</span>
        <span class="k-equals">=</span>
        <div class="k-fraction">
          <span class="k-numerator">
            <span class="term maintained">maintained</span>
            <span class="operator">+</span>
            <span class="term accumulators">accumulators</span>
          </span>
          <span class="k-fraction-bar"></span>
          <span class="k-denominator">total holders</span>
        </div>
      </div>

      <!-- K Display with Sacred Geometry -->
      <div class="k-sacred">
        <!-- Golden rings -->
        <div class="sacred-ring outer"></div>
        <div class="sacred-ring inner"></div>

        <!-- K Value Center -->
        <div class="k-center">
          <div class="k-labels">
            <span class="label-noise">price is noise</span>
            <span class="label-signal">K is signal</span>
          </div>
          <div class="k-metric">
            <span class="k-value loading" id="k-value">--%</span>
          </div>
          <div class="k-insight">Ï† Â· 552 Â· on-chain</div>
        </div>
      </div>

      <!-- Stats Row - Golden Angle Layout -->
      <div class="stats-row sacred">
        <div class="stat tooltip" data-tip="ğŸ”¥ wallets with >= $1 worth of tokens">
          <div class="stat-value" id="holders-count">--</div>
          <div class="stat-label">holders</div>
        </div>
        <div class="stat tooltip" data-tip="ğŸ’ diamond hands who never sold">
          <div class="stat-value gold" id="never-sold">--%</div>
          <div class="stat-label">diamond</div>
        </div>
        <div class="stat tooltip" data-tip="ğŸ“ˆ chads who accumulated more">
          <div class="stat-value green" id="accumulated">--%</div>
          <div class="stat-label">acc</div>
        </div>
        <div class="stat tooltip" data-tip="ğŸ–ï¸ early believers from first 21 days">
          <div class="stat-value orange" id="og-holders">--%</div>
          <div class="stat-label">OG</div>
        </div>
      </div>
    </main>

    <!-- History Panel -->
    <section class="panel history-panel">
      <div class="history-header">
        <span class="panel-title tooltip" data-tip="ğŸ“Š daily snapshots of K - watch the conviction evolve">K history</span>
        <span class="panel-title" id="history-count">0 snapshots</span>
      </div>
      <div class="history-body">
        <div class="chart-container" id="chart-container" style="position: relative; height: 240px; width: 100%;">
          <canvas id="kHistoryChart"></canvas>
          <div class="no-data" id="no-data-msg" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #888;">No historical data yet</div>
        </div>
      </div>
      <div class="poh-status tooltip" data-tip="â›“ï¸ Solana Proof of History - cryptographic timestamp for ordering">
        <span class="poh-label">PoH Slot:</span>
        <a class="poh-value poh-link" id="poh-slot" href="#" target="_blank" rel="noopener">--</a>
      </div>
    </section>

    <!-- Top Holders Section -->
    <section class="panel holders-panel">
      <div class="panel-header">
        <span class="panel-title tooltip" data-tip="ğŸ§¬ conviction across ALL pump.fun + dev.fun tokens - the real DNA">ğŸ§¬ top holders HODL DNA</span>
        <label class="pool-toggle tooltip" data-tip="Hide DEX liquidity pools from list">
          <input type="checkbox" id="hide-pools-toggle" checked>
          <span class="pool-toggle-label">hide pools</span>
        </label>
        <span class="panel-title" id="holders-coverage">--</span>
      </div>
      <div class="holders-list" id="holders-list">
        <div class="holders-loading">loading holders...</div>
      </div>
    </section>

    <!-- Sync Status - This is Fine Mode ğŸ•ğŸ”¥ -->
    <section class="sync-status" id="sync-status">
      <div class="sync-header">
        <span class="sync-icon" id="sync-icon">ğŸ•</span>
        <span class="sync-title">sync status</span>
        <span class="sync-mode" id="sync-mode">--</span>
      </div>
      <div class="sync-stats">
        <div class="sync-stat tooltip" data-tip="Wallets tracked in local DB">
          <span class="sync-stat-value" id="sync-wallets">--</span>
          <span class="sync-stat-label">wallets</span>
        </div>
        <div class="sync-stat tooltip" data-tip="Total transactions processed">
          <span class="sync-stat-value" id="sync-txs">--</span>
          <span class="sync-stat-label">txs</span>
        </div>
        <div class="sync-stat tooltip" data-tip="PoH slot - cryptographic ordering">
          <span class="sync-stat-value" id="sync-slot">--</span>
          <span class="sync-stat-label">slot</span>
        </div>
        <div class="sync-stat tooltip" data-tip="K_wallet calculation queue">
          <span class="sync-stat-value" id="sync-queue">--</span>
          <span class="sync-stat-label">queue</span>
        </div>
      </div>
      <div class="sync-message" id="sync-message">this is fine ğŸ”¥</div>
      <div class="live-feed" id="live-feed">
        <div class="live-feed-header">
          <span class="live-dot"></span>
          <span>live txs</span>
        </div>
        <div class="live-feed-list" id="live-feed-list"></div>
      </div>
    </section>

    <!-- Actions -->
    <div class="actions-bar">
      <button class="btn btn-primary" id="refresh-btn">
        <span>ğŸ”„</span> Refresh K
      </button>
      <button class="btn btn-twitter" id="share-btn">
        <span>ğŸ“¸</span> Screenshot & Share
      </button>
    </div>

    <!-- Check Your K -->
    <div class="actions-bar" style="margin-top: 1rem;">
      <a href="/wallet" class="btn btn-primary" style="text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;">
        <span>ğŸ”</span> Check Your K Score
      </a>
    </div>

    <!-- Footer Stats -->
    <div class="footer-stats">
      <div class="footer-stat tooltip" data-tip="ğŸ”¥ average time in the fire">
        <div class="footer-stat-value" id="avg-hold">--</div>
        <div class="footer-stat-label">avg hold days</div>
      </div>
      <div class="footer-stat tooltip" data-tip="ğŸ‘‘ early + long-term holders - the OG crew">
        <div class="footer-stat-value" id="og-pct">--%</div>
        <div class="footer-stat-label">OG holders</div>
      </div>
      <div class="footer-stat tooltip" data-tip="ğŸ’° fully diluted valuation - just a number tbh">
        <div class="footer-stat-value" id="token-mcap">--</div>
        <div class="footer-stat-label">mcap</div>
      </div>
      <div class="footer-stat tooltip" data-tip="â° last data refresh from Helius RPC">
        <div class="footer-stat-value" id="last-update">--</div>
        <div class="footer-stat-label">last update</div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <div class="footer-links">
        Powered by <a href="https://helius.dev" target="_blank">Helius</a>
        Â· <a href="https://alonisthe.dev" target="_blank">alonisthe.dev</a>
      </div>
      <div class="footer-motto">chaos is a filter ğŸ”¥</div>
    </footer>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script type="module">
    // ============================================
    // Config
    // ============================================
    const API_BASE = '/k-metric';

    // ============================================
    // DOM Elements
    // ============================================
    const elements = {
      statusDot: document.getElementById('status-dot'),
      statusText: document.getElementById('status-text'),
      kValue: document.getElementById('k-value'),
      holdersCount: document.getElementById('holders-count'),
      neverSold: document.getElementById('never-sold'),
      accumulated: document.getElementById('accumulated'),
      tickerK: document.getElementById('ticker-k'),
      tickerK2: document.getElementById('ticker-k-2'),
      chartContainer: document.getElementById('chart-container'),
      chartLabels: document.getElementById('chart-labels'),
      chartStart: document.getElementById('chart-start'),
      historyCount: document.getElementById('history-count'),
      avgHold: document.getElementById('avg-hold'),
      ogPct: document.getElementById('og-pct'),
      ogHolders: document.getElementById('og-holders'),
      tokenMcap: document.getElementById('token-mcap'),
      lastUpdate: document.getElementById('last-update'),
      refreshBtn: document.getElementById('refresh-btn'),
      shareBtn: document.getElementById('share-btn'),
      toast: document.getElementById('toast'),
    };

    // ============================================
    // State
    // ============================================
    let currentData = null;
    let isRefreshing = false;
    let cachedHoldersData = null;

    // ============================================
    // "This is Fine" Mode ğŸ•ğŸ”¥
    // ============================================
    const thisIsFineQuotes = [
      { text: "this is fine ğŸ•ğŸ”¥", sub: "fetching on-chain data..." },
      { text: "todo esta bien ğŸ”¥", sub: "el caos es un filtro..." },
      { text: "c'est fine ğŸ•", sub: "on brÃ»le les donnÃ©es pour toi..." },
      { text: "å¤§ä¸ˆå¤« ğŸ”¥", sub: "daijoubu... probably..." },
      { text: "Ğ²ÑĞµ Ñ…Ğ¾Ñ€Ğ¾ÑˆĞ¾ ğŸ•ğŸ”¥", sub: "just vibing in the fire..." },
      { text: "ğŸ• woof ğŸ”¥", sub: "blockchain go brrr..." },
      { text: "cope.exe ğŸ”¥", sub: "loading hopium..." },
      { text: "wen K? ğŸ•", sub: "soonâ„¢..." },
      { text: "gm ğŸ”¥", sub: "grinding on-chain data..." },
      { text: "wagmi ğŸ•ğŸ”¥", sub: "trust the process..." },
    ];

    let thisIsFineInterval = null;
    let quoteIndex = 0;

    function enterThisIsFineMode() {
      elements.kValue.classList.add('this-is-fine');
      updateThisIsFineQuote();
      thisIsFineInterval = setInterval(updateThisIsFineQuote, 3000);
    }

    function exitThisIsFineMode() {
      elements.kValue.classList.remove('this-is-fine');
      if (thisIsFineInterval) {
        clearInterval(thisIsFineInterval);
        thisIsFineInterval = null;
      }
      const insight = document.querySelector('.k-insight');
      if (insight) insight.textContent = 'Ï† Â· 552 Â· on-chain';
    }

    function updateThisIsFineQuote() {
      const quote = thisIsFineQuotes[quoteIndex % thisIsFineQuotes.length];
      elements.kValue.textContent = quote.text;
      const insight = document.querySelector('.k-insight');
      if (insight) insight.textContent = quote.sub;
      quoteIndex++;
    }

    // ============================================
    // API Functions
    // ============================================
    async function fetchKMetric() {
      const res = await fetch(API_BASE);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    }

    async function fetchHistory() {
      const res = await fetch(`${API_BASE}/history?days=30`);
      if (!res.ok) return { history: [] };
      return await res.json();
    }

    async function fetchStats() {
      const res = await fetch(`${API_BASE}/stats`);
      if (!res.ok) return null;
      return await res.json();
    }

    async function fetchHolders() {
      // Fetch extra to ensure 10 non-pools when filtering
      const res = await fetch(`${API_BASE}/holders?limit=20`);
      if (!res.ok) return { holders: [], k_wallet_coverage: {} };
      return await res.json();
    }

    // ============================================
    // UI Functions
    // ============================================
    function updateDisplay(data) {
      if (!data) return;
      currentData = data;

      exitThisIsFineMode();

      // K value with color
      const k = data.k ?? 0;
      elements.kValue.textContent = `${k}%`;
      elements.kValue.className = 'k-value';
      if (k < 50) {
        elements.kValue.classList.add('danger');
      } else if (k < 70) {
        elements.kValue.classList.add('warning');
      }

      // Stats
      elements.holdersCount.textContent = (data.holders ?? 0).toLocaleString();
      elements.neverSold.textContent = `${data.neverSoldPct ?? 0}%`;
      elements.accumulated.textContent = `${data.accumulatorsPct ?? data.accumulatedPct ?? 0}%`;

      // Ticker
      elements.tickerK.textContent = k;
      elements.tickerK2.textContent = k;

      // Footer stats
      elements.avgHold.textContent = data.avgHoldDays ?? '--';
      elements.ogPct.textContent = `${data.ogPct ?? 0}%`;

      // Orbital OG stat
      if (elements.ogHolders) {
        elements.ogHolders.textContent = `${data.ogPct ?? 0}%`;
      }
      if (data.token?.mcap && data.token.mcap > 0) {
        // Format mcap nicely (e.g., $91K, $1.2M)
        const mcap = data.token.mcap;
        if (mcap >= 1e6) {
          elements.tokenMcap.textContent = `$${(mcap / 1e6).toFixed(1)}M`;
        } else if (mcap >= 1e3) {
          elements.tokenMcap.textContent = `$${(mcap / 1e3).toFixed(0)}K`;
        } else {
          elements.tokenMcap.textContent = `$${mcap.toFixed(0)}`;
        }
      } else {
        elements.tokenMcap.textContent = '--';
      }
      elements.lastUpdate.textContent = new Date().toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit'
      });

      updateStatus('online', 'live');
    }

    function updateStatus(status, text) {
      elements.statusDot.className = 'status-dot';
      if (status === 'offline') elements.statusDot.classList.add('offline');
      if (status === 'warning') elements.statusDot.classList.add('warning');
      elements.statusText.textContent = text;
    }

    function showToast(message, isError = false) {
      elements.toast.textContent = message;
      elements.toast.className = 'toast' + (isError ? ' error' : '');
      elements.toast.classList.add('show');
      setTimeout(() => elements.toast.classList.remove('show'), 3000);
    }

    // ============================================
    // History Chart (Chart.js)
    // ============================================
    let kChartInstance = null;

    async function renderHistory() {
      try {
        const { history } = await fetchHistory();
        elements.historyCount.textContent = `${history.length} snapshots`;

        const noDataMsg = document.getElementById('no-data-msg');
        const ctx = document.getElementById('kHistoryChart').getContext('2d');

        if (history.length < 1) {
          noDataMsg.style.display = 'block';
          if (kChartInstance) kChartInstance.destroy();
          return;
        }

        noDataMsg.style.display = 'none';

        // Filter to keep only the latest snapshot per day to clean up the chart
        // This handles edge cases where multiple snapshots might exist for the same day due to restarts/tests
        const dailyMap = new Map();
        // Process in original order (newest first)
        history.forEach(h => {
          const day = h.date.split('T')[0];
          if (!dailyMap.has(day)) {
            dailyMap.set(day, h); // Keep the first one encountered (which is the latest/newest)
          }
        });
        
        // Convert back to array and reverse to show oldest first
        const data = Array.from(dailyMap.values()).reverse();

        const labels = data.map(h => new Date(h.date).toLocaleDateString(undefined, { month: 'short', day: 'numeric' }));
        const values = data.map(h => h.k);

        // Destroy existing chart if any
        if (kChartInstance) {
          kChartInstance.destroy();
        }

        // Create gradient
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(251, 146, 60, 0.5)'); // #fb923c (orange)
        gradient.addColorStop(1, 'rgba(251, 146, 60, 0)');

        Chart.defaults.font.family = "'JetBrains Mono', monospace";
        Chart.defaults.color = '#888';

        kChartInstance = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'K Metric',
              data: values,
              borderColor: '#fb923c', // Fire orange
              backgroundColor: gradient,
              borderWidth: 2,
              tension: 0.4, // Smooth curve
              fill: true,
              pointBackgroundColor: '#fbbf24', // Gold
              pointBorderColor: '#1a0a02',
              pointHoverBackgroundColor: '#fff',
              pointHoverBorderColor: '#fb923c',
              pointRadius: 4,
              pointHoverRadius: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                backgroundColor: 'rgba(26, 10, 2, 0.9)',
                titleColor: '#fb923c',
                bodyColor: '#fff',
                borderColor: '#fb923c',
                borderWidth: 1,
                padding: 10,
                displayColors: false,
                callbacks: {
                  label: function(context) {
                    return `K = ${context.parsed.y}%`;
                  }
                }
              }
            },
            scales: {
              x: {
                grid: {
                  color: 'rgba(255, 255, 255, 0.05)',
                  borderColor: 'rgba(255, 255, 255, 0.1)'
                },
                ticks: {
                  color: '#666',
                  maxRotation: 45,
                  minRotation: 0
                }
              },
              y: {
                beginAtZero: false, // Let it float to show variations better
                grid: {
                  color: 'rgba(255, 255, 255, 0.05)',
                  borderColor: 'rgba(255, 255, 255, 0.1)'
                },
                ticks: {
                  color: '#666',
                  callback: function(value) {
                    return value + '%';
                  }
                }
              }
            },
            interaction: {
              intersect: false,
              mode: 'index',
            },
          }
        });

      } catch (e) {
        console.error('Failed to load history:', e);
      }
    }

    async function updatePoHStatus() {
      try {
        const stats = await fetchStats();
        if (stats && stats.lastProcessedSlot) {
          const pohSlot = document.getElementById('poh-slot');
          if (pohSlot) {
            pohSlot.textContent = stats.lastProcessedSlot.toLocaleString();
            pohSlot.href = `https://solscan.io/block/${stats.lastProcessedSlot}`;
          }
        }
      } catch (e) {
        console.error('Failed to load PoH status:', e);
      }
    }

    // This is fine messages for sync status
    const syncMessages = [
      'this is fine ğŸ”¥',
      'everything is fine ğŸ•',
      'totally normal ğŸ”¥',
      'nothing to see here ğŸ•ğŸ”¥',
      'synced and cozy ğŸ”¥',
      'blockchain is fine ğŸ•',
      'all systems nominal ğŸ”¥',
    ];

    async function updateSyncStatus() {
      try {
        const res = await fetch(`${API_BASE}/status`);
        if (!res.ok) return;
        const data = await res.json();

        const syncSection = document.getElementById('sync-status');
        const syncIcon = document.getElementById('sync-icon');
        const syncMode = document.getElementById('sync-mode');
        const syncWallets = document.getElementById('sync-wallets');
        const syncTxs = document.getElementById('sync-txs');
        const syncSlot = document.getElementById('sync-slot');
        const syncQueue = document.getElementById('sync-queue');
        const syncMessage = document.getElementById('sync-message');

        // Update stats
        if (data.sync) {
          syncWallets.textContent = (data.sync.wallets || 0).toLocaleString();
          syncTxs.textContent = formatCompact(data.sync.transactions || 0);
          syncSlot.textContent = formatCompact(data.sync.lastProcessedSlot || 0);
        }

        // Queue status
        if (data.queue) {
          const queueSize = data.queue.queue_size || 0;
          const active = data.queue.active_calculations || 0;
          syncQueue.textContent = queueSize > 0 ? `${queueSize}+${active}` : 'âœ“';
        }

        // Sync mode
        const isWebhook = data.mode === 'hybrid';
        syncMode.textContent = isWebhook ? 'âš¡ webhook' : 'ğŸ”„ polling';
        syncMode.className = 'sync-mode' + (isWebhook ? ' webhook' : '');

        // Syncing state
        const isSyncing = data.queue?.queue_size > 0 || data.queue?.active_calculations > 0;
        syncSection.className = 'sync-status' + (isSyncing ? ' syncing' : '');
        syncIcon.textContent = isSyncing ? 'ğŸ•â€ğŸ¦º' : 'ğŸ•';

        // Random message
        const msg = syncMessages[Math.floor(Math.random() * syncMessages.length)];
        syncMessage.textContent = isSyncing ? 'syncing... this is fine ğŸ”¥' : msg;

      } catch (e) {
        console.error('Failed to update sync status:', e);
      }
    }

    function formatCompact(num) {
      if (num >= 1e9) return (num / 1e9).toFixed(1) + 'B';
      if (num >= 1e6) return (num / 1e6).toFixed(1) + 'M';
      if (num >= 1e3) return (num / 1e3).toFixed(0) + 'K';
      return num.toLocaleString();
    }

    // ============================================
    // Live Transaction Feed
    // ============================================
    let lastTxSignature = null;

    async function updateLiveFeed() {
      try {
        const response = await fetch(`${API_BASE}/live?limit=8`);
        if (!response.ok) return;

        const data = await response.json();
        const list = document.getElementById('live-feed-list');
        if (!list || !data.transactions) return;

        // Check if we have new transactions
        if (data.transactions.length > 0 && data.transactions[0].signature !== lastTxSignature) {
          lastTxSignature = data.transactions[0].signature;

          list.innerHTML = data.transactions.map(tx => {
            const wallet = tx.wallet ? `${tx.wallet.slice(0, 4)}...${tx.wallet.slice(-4)}` : '???';
            const ago = tx.ago ? (tx.ago < 60 ? `${tx.ago}s` : `${Math.floor(tx.ago / 60)}m`) : '';
            const amount = Math.abs(parseFloat(tx.amount)).toLocaleString();

            return `
              <div class="live-tx">
                <span class="live-tx-type ${tx.type}">${tx.type === 'buy' ? 'â†—' : 'â†˜'}</span>
                <a class="live-tx-wallet" href="https://solscan.io/account/${tx.wallet}" target="_blank" rel="noopener">${wallet}</a>
                <span class="live-tx-amount">${amount}</span>
                <span class="live-tx-ago">${ago}</span>
              </div>
            `;
          }).join('');
        }
      } catch (e) {
        console.error('Failed to update live feed:', e);
      }
    }

    // ============================================
    // Holders List
    // ============================================
    function getHodlDnaClass(k) {
      if (k === null) return 'pending';
      if (k >= 80) return 'diamond';
      if (k >= 50) return 'holder';
      if (k >= 20) return 'reducer';
      return 'extractor';
    }

    function getHodlDnaEmoji(k) {
      if (k === null) return 'â³';
      if (k >= 80) return 'ğŸ’';
      if (k >= 50) return 'ğŸ”¥';
      if (k >= 20) return 'ğŸ•';
      return 'ğŸƒ';
    }

    function formatBalance(balance) {
      const num = parseFloat(balance) / 1e6;
      if (num >= 1e9) return (num / 1e9).toFixed(1) + 'B';
      if (num >= 1e6) return (num / 1e6).toFixed(1) + 'M';
      if (num >= 1e3) return (num / 1e3).toFixed(0) + 'K';
      return num.toFixed(0);
    }

    async function renderHolders(forceRefresh = false) {
      const holdersList = document.getElementById('holders-list');
      const coverageEl = document.getElementById('holders-coverage');
      const hidePoolsToggle = document.getElementById('hide-pools-toggle');
      const hidePools = hidePoolsToggle?.checked ?? true;

      try {
        // Use cache if available and not forcing refresh
        if (!forceRefresh && cachedHoldersData) {
          // Just re-render with cached data
        } else {
          cachedHoldersData = await fetchHolders();
        }

        let { holders, k_wallet_coverage, pools_detected } = cachedHoldersData;

        // Filter pools if toggle is checked, then limit to 10
        if (hidePools && holders) {
          holders = holders.filter(h => !h.isPool).slice(0, 10);
        } else if (holders) {
          holders = holders.slice(0, 10);
        }

        if (k_wallet_coverage) {
          const pct = Math.round((k_wallet_coverage.calculated / (k_wallet_coverage.calculated + k_wallet_coverage.pending)) * 100) || 0;
          coverageEl.textContent = pools_detected > 0 ? `${pct}% scanned (${pools_detected} pools)` : `${pct}% scanned`;
        }

        if (!holders || holders.length === 0) {
          holdersList.innerHTML = '<div class="holders-loading">no holders found</div>';
          return;
        }

        holdersList.innerHTML = holders.map((h, i) => {
          const shortAddr = h.address.slice(0, 4) + '...' + h.address.slice(-4);

          // Pool detection - show special badge instead of DNA
          if (h.isPool) {
            return `
              <div class="holder-row pool-row">
                <div class="holder-info">
                  <span class="holder-rank">#${i + 1}</span>
                  <a href="https://solscan.io/account/${h.address}" target="_blank" class="holder-address">${shortAddr}</a>
                  <div class="holder-badges">
                    <span class="holder-badge pool">ğŸŒŠ POOL</span>
                  </div>
                </div>
                <div class="holder-stats">
                  <div class="holder-stat">
                    <div class="holder-stat-value">${formatBalance(h.balance)}</div>
                    <div class="holder-stat-label">liquidity</div>
                  </div>
                </div>
                <div class="holder-dna">
                  <div class="holder-dna-value pool">ğŸŒŠ LP</div>
                  <div class="holder-dna-label">DEX Pool</div>
                </div>
              </div>
            `;
          }

          const dnaClass = getHodlDnaClass(h.k_wallet);
          const dnaEmoji = getHodlDnaEmoji(h.k_wallet);
          const dnaValue = h.k_wallet !== null ? `${h.k_wallet}%` : '...';

          let badges = '';
          if (h.isOG) badges += '<span class="holder-badge og">OG</span>';
          if (h.neverSold) badges += '<span class="holder-badge diamond">ğŸ’</span>';

          return `
            <div class="holder-row">
              <div class="holder-info">
                <span class="holder-rank">#${i + 1}</span>
                <a href="/wallet?wallet=${h.address}" class="holder-address">${shortAddr}</a>
                <div class="holder-badges">${badges}</div>
              </div>
              <div class="holder-stats">
                <div class="holder-stat">
                  <div class="holder-stat-value">${formatBalance(h.balance)}</div>
                  <div class="holder-stat-label">balance</div>
                </div>
                <div class="holder-stat">
                  <div class="holder-stat-value">${h.holdDays}d</div>
                  <div class="holder-stat-label">held</div>
                </div>
              </div>
              <div class="holder-dna">
                <div class="holder-dna-value ${dnaClass}">${dnaEmoji} ${dnaValue}</div>
                <div class="holder-dna-label">HODL DNA</div>
              </div>
            </div>
          `;
        }).join('');

      } catch (e) {
        console.error('Failed to load holders:', e);
        holdersList.innerHTML = '<div class="holders-loading">error loading holders</div>';
      }
    }

    // ============================================
    // Actions
    // ============================================
    async function refresh() {
      if (isRefreshing) return;
      isRefreshing = true;
      elements.refreshBtn.disabled = true;

      try {
        updateStatus('warning', 'refreshing...');
        enterThisIsFineMode();

        const data = await fetchKMetric();

        if (data.error) {
          throw new Error(data.error);
        }

        updateDisplay(data);
        await renderHistory();
        await updatePoHStatus();
        await updateSyncStatus();
        await renderHolders(true);
        showToast('K-Metric updated! ğŸ”¥');
      } catch (error) {
        console.error('Refresh error:', error);
        showToast('Failed to fetch data', true);
        updateStatus('offline', 'error');
      } finally {
        isRefreshing = false;
        elements.refreshBtn.disabled = false;
      }
    }

    async function shareOnTwitter() {
      if (!currentData) {
        showToast('No data to share', true);
        return;
      }

      showToast('Generating screenshot... ğŸ“¸');
      elements.shareBtn.disabled = true;

      try {
        // Capture the main dashboard area
        const appElement = document.querySelector('.app');

        // Hide elements we don't want in screenshot
        const actionsBar = document.querySelector('.actions-bar');
        const footer = document.querySelector('.footer');
        const fireParticles = document.querySelectorAll('.fire-particle');

        actionsBar.style.display = 'none';
        footer.style.display = 'none';
        fireParticles.forEach(p => p.style.display = 'none');

        // Generate screenshot
        const canvas = await html2canvas(appElement, {
          backgroundColor: '#1a0a02',
          scale: 2, // Higher quality
          logging: false,
          useCORS: true,
        });

        // Restore hidden elements
        actionsBar.style.display = '';
        footer.style.display = '';
        fireParticles.forEach(p => p.style.display = '');

        // Convert to blob and download
        canvas.toBlob(async (blob) => {
          // Create download link
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `asdfasdfa-k-metric-${currentData.k}pct.png`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          showToast('Screenshot saved! Now share on Twitter ğŸ”¥');

          // Open Twitter with pre-filled text
          const accPct = currentData.accumulatorsPct ?? currentData.accumulatedPct ?? 0;
          const text = `$asdfasdfa K = ${currentData.k}%

ğŸ“Š ${currentData.holders} holders tracked
ğŸ’ ${currentData.neverSoldPct}% never sold
ğŸ“ˆ ${accPct}% accumulated

price is noise, K is signal
chaos is a filter ğŸ”¥

#asdfasdfa #Solana`;

          // Small delay to let user see the downloaded file
          setTimeout(() => {
            const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
            window.open(twitterUrl, '_blank');
          }, 500);

        }, 'image/png');

      } catch (error) {
        console.error('Screenshot error:', error);
        showToast('Screenshot failed, opening Twitter anyway...', true);

        // Fallback: just open Twitter without screenshot
        const accPct = currentData.accumulatorsPct ?? currentData.accumulatedPct ?? 0;
        const text = `$asdfasdfa K = ${currentData.k}%

ğŸ“Š ${currentData.holders} holders tracked
ğŸ’ ${currentData.neverSoldPct}% never sold
ğŸ“ˆ ${accPct}% accumulated

price is noise, K is signal
chaos is a filter ğŸ”¥

#asdfasdfa #Solana`;
        const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
        window.open(twitterUrl, '_blank');
      } finally {
        elements.shareBtn.disabled = false;
      }
    }

    // ============================================
    // Fire Particles
    // ============================================
    function startFireParticles() {
      setInterval(() => {
        if (document.hidden) return;

        const particle = document.createElement('div');
        particle.className = 'fire-particle';
        particle.textContent = 'ğŸ”¥';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.bottom = '0';
        document.body.appendChild(particle);

        setTimeout(() => particle.remove(), 4000);
      }, 2000);
    }

    // ============================================
    // Init
    // ============================================
    async function init() {
      console.log('[App] Initializing K-Metric Dashboard...');

      elements.refreshBtn.addEventListener('click', refresh);
      elements.shareBtn.addEventListener('click', shareOnTwitter);

      // Pool toggle - re-render holders on change (use cache, don't refetch)
      document.getElementById('hide-pools-toggle')?.addEventListener('change', () => renderHolders(false));

      // Auto-refresh on tab visible
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden && !isRefreshing) refresh();
      });

      startFireParticles();

      // Live feed updates every 3 seconds
      updateLiveFeed();
      setInterval(updateLiveFeed, 3000);

      await refresh();
    }

    init();
  </script>
</body>
</html>
